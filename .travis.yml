language: node_js
node_js:
  - '8.1.4'
cache:
  yarn: true
  directories:
    - frontend/node_modules
services:
  - docker
# UI dependencies
env:
  - IMAGE_PREFIX=quay.io/helmpack
before_install:
  - export CHROME_BIN=chromium-browser
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
install:
  - make -C frontend install
  - make -C frontend VERSION=$TRAVIS_TAG set-version
  # required due to apparent yarn issue with node-sass: https://github.com/sass/node-sass/issues/1971
  - npm --prefix frontend rebuild node-sass
script:
  - make -C frontend docker-build # Tests disabled for now
after_success:
  - |
    if [[ "$TRAVIS_PULL_REQUEST" = false ]] && [[ "$TRAVIS_BRANCH" = "master" || -n "$TRAVIS_TAG" ]]; then
      if [[ -n "$TRAVIS_TAG" ]]; then
        docker tag $IMAGE_PREFIX/monocular-ui:latest $IMAGE_PREFIX/monocular-ui:$TRAVIS_TAG
      fi
      docker login -u="$DOCKER_USER" -p="$DOCKER_PASSWORD" quay.io
      docker push $IMAGE_PREFIX/monocular-ui

      ./scripts/repo-sync.sh
    fi

branches:
  only:
    - master
    # TODO: remove this when dev-v1 branch is merged into master
    - dev-v1
    # release tags
    - /^v\d+\.\d+\.\d+.*/
